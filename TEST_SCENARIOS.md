# Test Scenarios - Verification Checklist

## Scenario 1: Small File (Should Download Immediately)
- **User Action**: Send URL to video < 50MB
- **Expected Flow**:
  1. `process_download()` validates URL âœ…
  2. Gets file size âœ…
  3. File size < 50MB â†’ Skips confirmation âœ…
  4. Calls `execute_confirmed_download()` directly âœ…
  5. Downloads, encodes, uploads video âœ…
- **Bot Logs Should Show**:
  - "Checking file size for URL..."
  - NO "Large file warning"
  - NO "waiting_for_confirmation" state
  - "Starting download for user..."
  - "Successfully processed video for user..."

## Scenario 2: Large File with Small Encoded Size (Should Show Confirmation)
- **User Action**: Send URL to video 50-200MB
- **Expected Flow**:
  1. `process_download()` validates URL âœ…
  2. Gets file size (e.g., 77MB) âœ…
  3. Estimates encoded size (e.g., ~7MB) âœ…
  4. Encoded size < 50MB â†’ Shows confirmation dialog âœ…
  5. Sets FSM state to `waiting_for_confirmation` âœ…
  6. Stores pending_url in database âœ…
- **Bot Logs Should Show**:
  - "Checking file size for URL..."
  - "Large file warning for user..."
  - "FSM state set to waiting_for_confirmation"
  - "Confirmation dialog shown to user"

## Scenario 3: User Confirms Download (Clicks "Yes")
- **User Action**: Clicks âœ… Yes, Continue button
- **Expected Flow**:
  1. `confirmation_handler()` receives callback âœ…
  2. Validates FSM state is `waiting_for_confirmation` âœ…
  3. Retrieves pending_url from database âœ…
  4. Validates pending_url exists and is valid âœ…
  5. Calls `execute_confirmed_download()` directly (NOT `process_download()`) âœ…
  6. Downloads, encodes, uploads video âœ…
- **Bot Logs Should Show**:
  - "User X confirmed download"
  - "FSM state set to downloading for user..."
  - NO re-check of file size
  - NO second confirmation dialog (THIS WAS THE BUG!)
  - "Starting download for user..."
  - "FSM state set to encoding for user..."
  - "FSM state set to uploading for user..."
  - "Successfully processed video for user..."

## Scenario 4: User Declines Download (Clicks "No")
- **User Action**: Clicks âŒ No, Cancel button
- **Expected Flow**:
  1. `confirmation_handler()` receives callback âœ…
  2. Validates FSM state is `waiting_for_confirmation` âœ…
  3. Clears pending_url from database âœ…
  4. Deletes confirmation message âœ…
  5. Clears FSM state âœ…
- **Bot Logs Should Show**:
  - "User X declined download"
  - Pending URL cleared
  - FSM state cleared
  - No error messages

## Scenario 5: Very Large File (Should Reject Immediately)
- **User Action**: Send URL to video > 200MB that encodes to > 50MB
- **Expected Flow**:
  1. `process_download()` validates URL âœ…
  2. Gets file size âœ…
  3. Estimates encoded size > 50MB âœ…
  4. Shows rejection message with suggestions âœ…
  5. NO confirmation dialog âœ…
  6. Clears FSM state âœ…
- **Bot Logs Should Show**:
  - "Checking file size for URL..."
  - "file too large even after encoding"
  - NO confirmation dialog
  - NO FSM state set

## Scenario 6: Download Timeout (> 1 hour)
- **User Action**: URL to extremely slow/large video
- **Expected Flow**:
  1. `execute_confirmed_download()` starts download âœ…
  2. `download_video()` has 3600s timeout âœ…
  3. After timeout â†’ Shows timeout message âœ…
  4. Cleans up temp directory âœ…
  5. Clears pending_url âœ…
- **Bot Logs Should Show**:
  - "Starting download for user..."
  - "Download timeout after 3600s for user"
  - "Cleaned up temp directory"

## Scenario 7: Invalid URL
- **User Action**: Send invalid/malformed URL
- **Expected Flow**:
  1. `process_download()` validates URL âœ…
  2. URL validation fails âœ…
  3. Shows error message âœ…
  4. Does NOT call execute_confirmed_download() âœ…
- **Bot Logs Should Show**:
  - "Invalid URL input from user" OR "Failed to validate URL"
  - Error message about invalid URL format

## Scenario 8: Message Edit Failure (Network Issue)
- **User Action**: Any download during message edit failure
- **Expected Flow**:
  1. Any message.edit_text() call fails âœ…
  2. Error is caught and logged âœ…
  3. Download continues anyway âœ…
  4. User still gets video âœ…
- **Bot Logs Should Show**:
  - "Failed to update status message for user..." (warning level)
  - Process continues normally

## Scenario 9: Database Error
- **User Action**: Get pending_url during DB issue
- **Expected Flow**:
  1. DB query fails âœ…
  2. Error is caught âœ…
  3. User gets error message âœ…
  4. FSM state is cleared âœ…
- **Bot Logs Should Show**:
  - "Failed to get pending URL for user..." (error level)
  - "Database error. Please try again."

## Critical Path: THE BUG FIX
- **Before**: confirmation_handler â†’ calls process_download() â†’ re-checks file size â†’ shows confirmation AGAIN â†’ INFINITE LOOP
- **After**: confirmation_handler â†’ calls execute_confirmed_download() â†’ skips file size check â†’ proceeds to download â†’ NO LOOP âœ…

## Verification Status
| Scenario | Status | Notes |
|----------|--------|-------|
| 1. Small file | âœ… Pending | Need to test with <50MB video |
| 2. Large file + confirmation | âœ… **VERIFIED** | Logs show correct flow! |
| 3. User confirms (Y ES) | ðŸ”„ **TESTING NOW** | Should download without re-check |
| 4. User declines (NO) | â³ Pending | Need to test |
| 5. Very large file | â³ Pending | Need to test with huge file |
| 6. Download timeout | â³ Pending | Needs 1+ hour download |
| 7. Invalid URL | â³ Pending | Need to test with bad URL |
| 8. Message edit failure | â³ Pending | Needs network issue simulation |
| 9. Database error | â³ Pending | Needs DB simulation |

